version: "3.9" # 최신 Compose Spec 버전 사용

services:
  db:
    image: postgres:16-alpine # PostgreSQL 16 버전으로 업데이트
    container_name: fraud-detection-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      # [수정] 버전 충돌을 피하기 위해 새 볼륨 이름(v16)을 사용합니다.
      - postgres_data_v16:/var/lib/postgresql/data
    ports:
      - "${DB_PORT}:5432"
    restart: unless-stopped

  backend:
    build: ./backend
    container_name: fraud-detection-backend
    # app/main.py 실행, /backend/app 폴더 감시
    command: uvicorn app.main:app --host 0.0.0.0 --port 8800 --reload --reload-dir /backend/app
    volumes:
      # [수정] backend 폴더 전체가 마운트되므로 개별 pkl 파일 마운트 라인 제거
      - ./backend:/backend
    ports:
      - "${HOST_BACKEND_PORT}:8800"
    environment:
      - ENV=${ENV}
      - ORIGINS=${ORIGINS}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      # DB 접속 URL 완성
      - DATABASE_URL=postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${DB_HOST}:${DB_PORT}/${POSTGRES_DB}
      # 모델 로드 경로 설정 (컨테이너 내부 경로는 변경 없음)
      - MODEL_PATH=/backend/model/fraud_detector_supervised.pkl
      - AMOUNT_SCALER_PATH=/backend/model/amount_scaler.pkl
      - TIME_SCALER_PATH=/backend/model/time_scaler.pkl
      - STATS_PATH=/backend/model/feature_stats.pkl
    depends_on:
      - db
    restart: unless-stopped

  frontend:
    # Dockerfile을 수정하여 node:20-alpine을 사용합니다.
    build: ./frontend
    container_name: fraud-detection-frontend
    volumes:
      - ./frontend:/frontend
      - /frontend/node_modules
    ports:
      - "${HOST_FRONTEND_PORT}:3300"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - PORT=3300
      # [수정] React 앱이 백엔드 포트를 알 수 있도록 환경변수 추가
      - REACT_APP_BACKEND_PORT=${HOST_BACKEND_PORT}
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  # [수정] 새 볼륨을 정의합니다.
  postgres_data_v16:
